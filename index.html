<!DOCTYPE html>
<html lang="vi">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>iTeX - Hแป Thแปng Kiแปm Tra Online</title>
ย ย ย ย <script src="https://cdn.tailwindcss.com"></script>
ย ย ย ย <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
ย ย ย ย <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
ย ย ย ย <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
ย ย <style>
ย ย ย ย body { font-family: 'Inter', sans-serif; background-color: #87F5DB; }
ย ย ย ย 
ย ย ย ย /* Custom Colors */
ย ย ย ย .bg-primary { background-color: #14BC9C; }
ย ย ย ย .bg-primary-hover:hover { background-color: #11A58A; }
ย ย ย ย .text-primary { color: #14BC9C; }
ย ย ย ย .border-primary { border-color: #14BC9C; }
ย ย ย ย 
ย ย ย ย /* UI Components */
ย ย ย ย .btn {
ย ย ย ย ย ย background-color: #14BC9C;
ย ย ย ย ย ย color: white;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย padding: 0.5rem 1.5rem;
ย ย ย ย ย ย border-radius: 0.5rem;
ย ย ย ย ย ย transition: all 0.2s;
ย ย ย ย ย ย box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
ย ย ย ย }
ย ย ย ย .btn:hover { background-color: #11A58A; transform: translateY(-1px); }
ย ย ย ย .btn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; }
ย ย ย ย 
ย ย ย ย .card { background: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
ย ย ย ย 
ย ย ย ย .input-field {
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย padding: 0.75rem;
ย ย ย ย ย ย border: 1px solid #d1d5db;
ย ย ย ย ย ย border-radius: 0.5rem;
ย ย ย ย ย ย outline: none;
ย ย ย ย ย ย transition: border-color 0.2s;
ย ย ย ย }
ย ย ย ย .input-field:focus { border-color: #14BC9C; ring: 2px solid #14BC9C; }
ย ย ย ย .input-error { border-color: #ef4444; ring: 2px solid #ef4444; }

ย ย ย ย .option-btn {
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย text-align: left;
ย ย ย ย ย ย padding: 1rem;
ย ย ย ย ย ย border: 2px solid #e5e7eb;
ย ย ย ย ย ย border-radius: 0.5rem;
ย ย ย ย ย ย transition: all 0.2s;
ย ย ย ย ย ย font-weight: 500;
ย ย ย ย }
ย ย ย ย .option-btn:hover:not(:disabled) { border-color: #14BC9C; background-color: #f0fdf4; }
ย ย ย ย .option-btn.selected { background-color: #FFD700; color: black; border-color: #b49700; font-weight: bold; }
ย ย ย ย 
ย ย ย ย .correct-answer { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #065f46 !important; }
ย ย ย ย .wrong-answer { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
ย ย ย ย 
ย ย ย ย .fade-in { animation: fadeIn 0.4s ease-out; }
ย ย ย ย @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
ย ย </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center">

ย ย <div id="app-container" class="w-full max-w-5xl">
ย ย ย ย ย ย ย ย <div class="flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-md">
ย ย ย ย ย ย <div class="flex items-center space-x-3">
ย ย ย ย ย ย ย ย <img src="logo.png" class="h-10 w-10 object-contain" alt="Logo">
ย ย ย ย ย ย ย ย <h1 class="text-xl font-bold text-gray-800">Hแป Thแปng Kiแปm Tra Online</h1>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div id="user-info" class="text-sm text-gray-500">ฤang tแบฃi...</div>
ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div id="loading" class="text-center py-20">
ย ย ย ย ย ย <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
ย ย ย ย ย ย <p class="mt-4 text-gray-600 font-medium">ฤang kแบฟt nแปi hแป thแปng...</p>
ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div id="main-content" class="hidden fade-in">
ย ย ย ย ย ย ย ย ย ย ย ย <div id="role-selection" class="card max-w-lg mx-auto text-center py-10">
ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 mb-8">Vui lรฒng chแปn vai trรฒ cแปงa bแบกn!</h2>
ย ย ย ย ย ย ย ย <div class="grid grid-cols-2 gap-6">
ย ย ย ย ย ย ย ย ย ย <button onclick="setRole('teacher')" class="btn py-8 text-xl flex flex-col items-center justify-center gap-2 hover:scale-105 transition-transform">
ย ย ย ย ย ย ย ย ย ย ย ย <span>๐จโ๐ซ</span>
ย ย ย ย ย ย ย ย ย ย ย ย GIรO VIรN
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button onclick="setRole('student')" class="btn py-8 text-xl flex flex-col items-center justify-center gap-2 hover:scale-105 transition-transform">
ย ย ย ย ย ย ย ย ย ย ย ย <span>๐จโ๐</span>
ย ย ย ย ย ย ย ย ย ย ย ย HแปC SINH
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <div id="teacher-view" class="hidden space-y-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="card">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">๐ Tแบกo ฤแป Kiแปm Tra Mแปi</h2>
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-semibold text-gray-700 mb-2">Hแป tรชn Giรกo viรชn <span class="text-red-500">*</span></label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="t-name" class="input-field" placeholder="Nhแบญp tรชn cแปงa bแบกn">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-semibold text-gray-700 mb-2">Thแปi gian lรm bรi (phรบt)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="t-time" class="input-field" value="15" min="1">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย <div class="flex items-center mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="checkbox" id="t-review" class="w-5 h-5 text-primary border-gray-300 rounded" checked>
ย ย ย ย ย ย ย ย ย ย ย ย <label for="t-review" class="ml-2 text-gray-700 font-medium">Cho phรฉp hแปc sinh xem ฤรกp รกn & lแปi giแบฃi sau khi nแปp</label>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-bold text-gray-800 mb-3">โ๏ธ Cแบฅu hรฌnh ฤiแปm sแป</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-gray-600">Trแบฏc nghiแปm (MCQ)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="score-mcq" class="input-field mt-1" step="0.01" value="0.25">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-gray-600">Trแบฃ lแปi ngแบฏn (SA)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="score-sa" class="input-field mt-1" step="0.01" value="0.5">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div><label class="block text-gray-600">ฤรบng/Sai (1 รฝ ฤรบng)</label><input type="number" id="score-tf1" class="input-field mt-1" step="0.01" value="0.1"></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div><label class="block text-gray-600">ฤรบng/Sai (2 รฝ ฤรบng)</label><input type="number" id="score-tf2" class="input-field mt-1" step="0.01" value="0.25"></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div><label class="block text-gray-600">ฤรบng/Sai (3 รฝ ฤรบng)</label><input type="number" id="score-tf3" class="input-field mt-1" step="0.01" value="0.5"></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div><label class="block text-gray-600">ฤรบng/Sai (4 รฝ ฤรบng)</label><input type="number" id="score-tf4" class="input-field mt-1" step="0.01" value="1.0"></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-8">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ Nhแบญp Liแปu Hรng Loแบกt (Excel + แบขnh)
ย ย ย ย ย ย ย ย ย ย ย ย </h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-semibold text-gray-700 mb-1">1. File ฤรกp รกn (Excel)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" id="batch-excel" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs text-gray-500 mt-1">Cแปt A: STT, Cแปt B: ฤรกp รกn</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="md:col-span-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="block text-sm font-semibold text-gray-700 mb-1">2. แบขnh Cรขu hแปi & Lแปi giแบฃi (Chแปn nhiแปu)</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" id="batch-all-imgs" multiple accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-xs text-gray-500 mt-1">Tรชn file phแบฃi chแปฉa STT vร cรณ tiแปn tแป: *Cau\_01...* (Cรขu hแปi) hoแบทc *Da\_01...* (Lแปi giแบฃi)</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="mt-4 text-right">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="processBatchEntry(this)" class="btn bg-blue-600 hover:bg-blue-700">โก Tแบกo cรขu hแปi</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-bold text-gray-800 mb-2 border-b pb-2">Danh Sรกch Cรขu Hแปi</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="questions-list" class="space-y-6 mb-6"></div>

ย ย ย ย ย ย ย ย ย ย <div class="flex flex-wrap gap-4 border-t pt-6">
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="addQuestion()" class="btn bg-green-500 hover:bg-green-600">+ Thรชm Thแปง Cรดng</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="saveExam(this)" class="btn ml-auto">๐พ Tแบกo ฤแป</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="card">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-6">๐ Xem Kแบฟt Quแบฃ Thi</h2>
ย ย ย ย ย ย ย ย ย ย <div class="flex gap-4 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="result-exam-id" class="input-field flex-grow" placeholder="Nhแบญp Mรฃ ฤแป ฤแป xem kแบฟt quแบฃ">
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="loadResults()" class="btn">Xem Kแบฟt Quแบฃ</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="results-table-container" class="overflow-x-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="card p-6 mb-6 hidden" id="results-chart-container">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 mb-4">Phรขn tรญch Tแปng ฤiแปm</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div style="height: 400px;"><canvas id="scoreChart"></canvas></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-500 text-center italic">Chฦฐa cรณ dแปฏ liแปu.</p>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <div id="student-view" class="hidden max-w-3xl mx-auto space-y-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="student-entry" class="card">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Vรo Thi</h2>
ย ย ย ย ย ย ย ย ย ย <div class="space-y-4">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="s-exam-id" class="input-field text-center text-xl tracking-widest uppercase" placeholder="NHแบฌP Mร ฤแป">
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="checkExam()" class="btn w-full py-3 text-lg">Kiแปm Tra Mรฃ ฤแป</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="student-info-form" class="card hidden">
ย ย ย ย ย ย ย ย ย ย <h3 id="exam-info-display" class="text-lg font-semibold text-center text-primary mb-4"></h3>
ย ย ย ย ย ย ย ย ย ย <div class="space-y-4">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="s-name" class="input-field" placeholder="Hแป vร tรชn hแปc sinh">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="s-school" class="input-field" placeholder="Trฦฐแปng">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="s-class" class="input-field" placeholder="Lแปp">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="startExam(event)" class="btn w-full py-3 font-bold bg-green-600 hover:bg-green-700">๐ BแบฎT ฤแบฆU LรM BรI</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="taking-exam" class="hidden">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="sticky top-4 z-50 bg-white p-4 rounded-xl shadow-lg border-2 border-primary mb-6 flex justify-between items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="font-bold text-gray-700">Thรญ sinh: <span id="display-s-name"></span></span>
ย ย ย ย ย ย ย ย ย ย ย ย <div id="timer" class="text-2xl font-mono font-bold text-red-600">00:00</div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div id="exam-questions-render" class="space-y-8"></div>

ย ย ย ย ย ย ย ย ย ย <div class="mt-8 text-center">
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="submitExam()" id="btn-submit" class="btn py-4 px-12 text-xl shadow-xl">Nแปp Bรi</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="student-result" class="card hidden text-center">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-3xl font-bold text-primary mb-2">๐ Hoรn Thรnh!</h2>
ย ย ย ย ย ย ย ย ย ย <p class="text-gray-600 mb-6">Bแบกn ฤรฃ nแปp bรi thรnh cรดng.</p>
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย <div class="bg-yellow-50 p-6 rounded-xl border-2 border-yellow-400 inline-block mb-8">
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-gray-500 uppercase font-semibold">Tแปng ฤiแปm</p>
ย ย ย ย ย ย ย ย ย ย ย ย <p id="final-score" class="text-6xl font-extrabold text-gray-800 mt-2">0.00</p>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div id="review-section" class="hidden text-left space-y-6 border-t pt-6">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800">Chi tiแบฟt bรi lรm:</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div id="review-questions"></div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย <button onclick="location.reload()" class="btn mt-8 bg-gray-600 hover:bg-gray-700">Thoรกt</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>
ย ย 
ย ย ย ย <div id="custom-alert-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-[9999]">
ย ย ย ย <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
ย ย ย ย ย ย <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3">Thรดng Bรกo</h3>
ย ย ย ย ย ย <p id="modal-message" class="text-gray-600 mb-6"></p>
ย ย ย ย ย ย <button id="modal-close-btn" onclick="document.getElementById('custom-alert-modal').classList.add('hidden')" class="btn bg-gray-500 hover:bg-gray-600">ฤรณng</button>
ย ย ย ย </div>
ย ย </div>


ย ย ย ย <script type="module">
ย ย ย ย import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
ย ย ย ย import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
ย ย ย ย import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

ย ย ย ย // CONFIG
ย ย ย ย // --- CHร ร QUAN TRแปNG: KHI ฤฦฏA LรN GITHUB, HรY THAY THแบพ CHUแปI JSON BรN DฦฏแปI BแบฐNG CแบคU HรNH FIREBASE CแปฆA RIรNG BแบN ---
ย ย ย ย const APP_ID_FALLBACK = 'itex-default-github';
ย ย ย ย const FIREBASE_CONFIG_PLACEHOLDER = `{
	"apiKey": "AIzaSyCY_WIQ_nAy4Guxg6OMRtNW-F6qhb2U4BI",
	"authDomain": "flutter-ai-playground-fd478.firebaseapp.com",
	"projectId": "flutter-ai-playground-fd478",
	"storageBucket": "flutter-ai-playground-fd478.firebasestorage.app",
	"messagingSenderId": "321777356764",
	"appId": "1:321777356764:web:7ea129a40de01a4cc5c919"
}`;
ย ย ย ย 
ย ย ย ย // Sแปญ dแปฅng cแบฅu hรฌnh ฤฦฐแปฃc cung cแบฅp tแปซ mรดi trฦฐแปng Canvas (nแบฟu cรณ)
ย ย ย ย const appId = typeof __app_id !== 'undefined' ? __app_id : APP_ID_FALLBACK;
ย ย ย ย 
ย ย ย ย let firebaseConfig;
ย ย ย ย let isCanvasEnvironment = false;

ย ย ย ย if (typeof __firebase_config !== 'undefined' && __firebase_config && Object.keys(JSON.parse(__firebase_config)).length > 0) {
ย ย ย ย ย ย // Mรดi trฦฐแปng Canvas cung cแบฅp cแบฅu hรฌnh
ย ย ย ย ย ย firebaseConfig = JSON.parse(__firebase_config);
ย ย ย ย ย ย isCanvasEnvironment = true;
ย ย ย ย } else {
ย ย ย ย ย ย // Mรดi trฦฐแปng GitHub/Local, cแบงn dรนng placeholder (YรU CแบฆU NGฦฏแปI DรNG Tแปฐ ฤIแปN)
ย ย ย ย ย ย firebaseConfig = JSON.parse(FIREBASE_CONFIG_PLACEHOLDER);
ย ย ย ย }

ย ย ย ย // INIT
ย ย ย ย let app, auth, db;
ย ย ย ย let userId = null;
ย ย ย ย let currentExamData = null; // For student
ย ย ย ย let examTimer = null;
ย ย ย ย let scoreChartInstance = null; // Biแบฟn toรn cแปฅc cho Chart.js instance

ย ย ย ย // Max Base64 size allowed for Firestore (approx 1.4MB in Base64 string length, safely below 1MB document limit)
ย ย ย ย const MAX_BASE64_SIZE = 1468006; // Corresponds to approx 1.0MB file size when encoded.
ย ย ย ย 
ย ย ย ย // Custom Alert Function (Replaces native alert)
ย ย ย ย // Cแบญp nhแบญt ฤแป nhแบญn callback/hรm hรnh ฤแปng khi ฤรณng alert
ย ย ย ย window.customAlert = (message, title = "Thรดng Bรกo", onClose = null) => {
ย ย ย ย ย ย document.getElementById('modal-title').innerText = title;
ย ย ย ย ย ย document.getElementById('modal-message').innerHTML = message; // Dรนng innerHTML cho mรฃ ฤแป ฤแบญm
ย ย ย ย ย ย const modal = document.getElementById('custom-alert-modal');
ย ย ย ย ย ย const closeBtn = document.getElementById('modal-close-btn');

ย ย ย ย ย ย // Xรณa sแปฑ kiแปn cลฉ
ย ย ย ย ย ย closeBtn.onclick = null;
ย ย ย ย ย ย 
ย ย ย ย ย ย // ฤแบทt sแปฑ kiแปn mแปi
ย ย ย ย ย ย closeBtn.onclick = () => {
ย ย ย ย ย ย ย ย modal.classList.add('hidden');
ย ย ย ย ย ย ย ย if (typeof onClose === 'function') {
ย ย ย ย ย ย ย ย ย ย onClose();
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย };
ย ย ย ย ย ย 
ย ย ย ย ย ย modal.classList.remove('hidden');
ย ย ย ย };

ย ย ย ย // Hรm kiแปm tra cแบฅu hรฌnh Firebase
ย ย ย ย const isFirebaseConfigured = () => {
ย ย ย ย ย ย if (isCanvasEnvironment) return true;
ย ย ย ย ย ย return firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId.length > 5;
ย ย ย ย }


ย ย ย ย // AUTH & INIT FLOW
ย ย ย ย if (isFirebaseConfigured()) {
ย ย ย ย ย ย app = initializeApp(firebaseConfig);
ย ย ย ย ย ย auth = getAuth(app);
ย ย ย ย ย ย db = getFirestore(app);

ย ย ย ย ย ย const initAuth = async () => {
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
ย ย ย ย ย ย ย ย ย ย ย ย await signInWithCustomToken(auth, __initial_auth_token);
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย await signInAnonymously(auth);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย ย ย console.error("Auth error", error);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย };
ย ย ย ย ย ย initAuth();

ย ย ย ย ย ย onAuthStateChanged(auth, (user) => {
ย ย ย ย ย ย ย ย if (user) {
ย ย ย ย ย ย ย ย ย ย userId = user.uid;
ย ย ย ย ย ย ย ย ย ย document.getElementById('user-info').innerText = `ID: ${userId.substring(0,6)}...`;
ย ย ย ย ย ย ย ย ย ย document.getElementById('loading').classList.add('hidden');
ย ย ย ย ย ย ย ย ย ย document.getElementById('main-content').classList.remove('hidden');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย } else {
ย ย ย ย ย ย // Fallback UI if Firebase not configured
ย ย ย ย ย ย document.getElementById('loading').classList.add('hidden');
ย ย ย ย ย ย document.getElementById('main-content').classList.remove('hidden');
ย ย ย ย ย ย window.customAlert("แปจng dแปฅng ฤang chแบกy trong chแบฟ ฤแป cแปฅc bแป/preview HOแบถC thiแบฟu cแบฅu hรฌnh Firebase. Cรกc tรญnh nฤng Lฦฐu/Tแบฃi ฤแป thi sแบฝ khรดng hoแบกt ฤแปng.", "LฦฏU ร QUAN TRแปNG");
ย ย ย ย }


ย ย ย ย // --- GLOBAL FUNCTIONS ---
ย ย ย ย window.setRole = (role) => {
ย ย ย ย ย ย document.getElementById('role-selection').classList.add('hidden');
ย ย ย ย ย ย if(role === 'teacher') {
ย ย ย ย ย ย ย ย document.getElementById('teacher-view').classList.remove('hidden');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย document.getElementById('student-view').classList.remove('hidden');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // --- TEACHER LOGIC ---

ย ย ย ย // Helper: Convert File to Base64
ย ย ย ย window.fileToBase64 = (input) => {
ย ย ย ย ย ย return new Promise((resolve, reject) => {
ย ย ย ย ย ย ย ย if(input instanceof File) {
ย ย ย ย ย ย ย ย ย ย const reader = new FileReader();
ย ย ย ย ย ย ย ย ย ย reader.onload = () => resolve(reader.result.split(',')[1]);ย
ย ย ย ย ย ย ย ย ย ย reader.onerror = error => reject(error);
ย ย ย ย ย ย ย ย ย ย reader.readAsDataURL(input);
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย // Handle normal input element
ย ย ย ย ย ย ย ย const file = input.files[0];
ย ย ย ย ย ย ย ย if (!file) { resolve(null); return; }
ย ย ย ย ย ย ย ย const reader = new FileReader();
ย ย ย ย ย ย ย ย reader.onload = () => resolve(reader.result.split(',')[1]);ย
ย ย ย ย ย ย ย ย reader.onerror = error => reject(error);
ย ย ย ย ย ย ย ย reader.readAsDataURL(file);
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย window.previewImage = (input, imgId) => {
ย ย ย ย ย ย const file = input.files[0];
ย ย ย ย ย ย if(file){
ย ย ย ย ย ย ย ย const reader = new FileReader();
ย ย ย ย ย ย ย ย reader.onload = (e) => {
ย ย ย ย ย ย ย ย ย ย const img = document.getElementById(imgId);
ย ย ย ย ย ย ย ย ย ย img.src = e.target.result;
ย ย ย ย ย ย ย ย ย ย img.classList.remove('hidden');
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย reader.readAsDataURL(file);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // --- BATCH UPLOAD LOGIC ---
ย ย ย ย window.processBatchEntry = async (btnElement) => {
ย ย ย ย ย ย // Hรm helper ฤแป trรญch xuแบฅt sแป vร loแบกi (q/s) dแปฑa trรชn tiแปn tแป Cau_xx, Da_xx
ย ย ย ย ย ย const extractNumberAndType = (filename) => {
ย ย ย ย ย ย ย ย const lowerName = filename.toLowerCase();
ย ย ย ย ย ย ย ย // Matches: Cau_01.jpg or Da_12.png or just number like 1.png
ย ย ย ย ย ย ย ย let match = lowerName.match(/^(cau|da)_(\d+)\./);
ย ย ย ย ย ย ย ย if (match) {
ย ย ย ย ย ย ย ย ย ย return {ย
ย ย ย ย ย ย ย ย ย ย ย ย type: match[1] === 'cau' ? 'q' : 's',ย
ย ย ย ย ย ย ย ย ย ย ย ย number: parseInt(match[2], 10)ย
ย ย ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย // Fallback (for older/simpler naming like 'cau1' or 'da1' or '1')
ย ย ย ย ย ย ย ย match = lowerName.match(/(\d+)/);
ย ย ย ย ย ย ย ย if(match) {
ย ย ย ย ย ย ย ย ย ย const number = parseInt(match[1], 10);
ย ย ย ย ย ย ย ย ย ย // Prioritize Da/S/Sol as solution, otherwise question
ย ย ย ย ย ย ย ย ย ย if (lowerName.includes('da') || lowerName.includes('sol') || lowerName.includes('_s')) {
ย ย ย ย ย ย ย ย ย ย ย ย return { type: 's', number };
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย // Default to question if only number is present and no type hint
ย ย ย ย ย ย ย ย ย ย return { type: 'q', number };
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย return null;
ย ย ย ย ย ย }

ย ย ย ย ย ย const excelInput = document.getElementById('batch-excel');
ย ย ย ย ย ย // ฤรฃ thay ฤแปi: Lแบฅy input แบฃnh gแปp
ย ย ย ย ย ย const allImgsInput = document.getElementById('batch-all-imgs');ย
ย ย ย ย ย ย const container = document.getElementById('questions-list');
ย ย ย ย ย ย 
ย ย ย ย ย ย if(!excelInput.files[0]) return customAlert("Vui lรฒng chแปn file Excel ฤรกp รกn!");
ย ย ย ย ย ย if(allImgsInput.files.length === 0) return customAlert("Vui lรฒng chแปn แบฃnh cรขu hแปi vร lแปi giแบฃi!");

ย ย ย ย ย ย const btn = btnElement || event.target;
ย ย ย ย ย ย btn.disabled = true;
ย ย ย ย ย ย btn.innerText = "ฤang xแปญ lรฝ...";

ย ย ย ย ย ย // 1. Parse Excel (Khรดng ฤแปi)
ย ย ย ย ย ย const reader = new FileReader();
ย ย ย ย ย ย reader.onload = async (e) => {
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย const data = new Uint8Array(e.target.result);
ย ย ย ย ย ย ย ย ย ย const workbook = XLSX.read(data, {type: 'array'});
ย ย ย ย ย ย ย ย ย ย const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
ย ย ย ย ย ย ย ย ย ย // Convert to array of arrays, assuming Header is Row 1
ย ย ย ย ย ย ย ย ย ย const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});ย
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย // Filter valid rows (skip header if needed, look for data)
ย ย ย ย ย ย ย ย ย ย // Assumption: Column 0 is Order, Column 1 is Answer
ย ย ย ย ย ย ย ย ย ย const validRows = rows.filter(r => r[0] && r[1]);
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย // 2. Map Images (ฤรฃ thay ฤแปi: Duyแปt qua tแบฅt cแบฃ แบฃnh vร phรขn loแบกi)
ย ย ย ย ย ย ย ย ย ย const qImgMap = {};
ย ย ย ย ย ย ย ย ย ย const sImgMap = {};
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย Array.from(allImgsInput.files).forEach(f => {
ย ย ย ย ย ย ย ย ย ย ย ย const info = extractNumberAndType(f.name);
ย ย ย ย ย ย ย ย ย ย ย ย if(info && info.number !== null) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย if(info.type === 'q') {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย qImgMap[info.number] = f;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย } else if (info.type === 's') {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย sImgMap[info.number] = f;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย ย ย // Clear current list if needed or append? Let's clear for batch
ย ย ย ย ย ย ย ย ย ย container.innerHTML = '';

ย ย ย ย ย ย ย ย ย ย // 3. Loop and Create
ย ย ย ย ย ย ย ย ย ย for(let i=0; i<validRows.length; i++) {
ย ย ย ย ย ย ย ย ย ย ย ย const row = validRows[i];
ย ย ย ย ย ย ย ย ย ย ย ย // Try to find STT. If first row is header like "STT", skip it
ย ย ย ย ย ย ย ย ย ย ย ย if(isNaN(parseInt(row[0]))) continue;ย

ย ย ย ย ย ย ย ย ย ย ย ย const stt = parseInt(row[0]);
ย ย ย ย ย ย ย ย ย ย ย ย const rawAns = String(row[1]).trim().toUpperCase();
ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย // Determine Type
ย ย ย ย ย ย ย ย ย ย ย ย let type = 'short_answer';
ย ย ย ย ย ย ย ย ย ย ย ย let ans = rawAns;
ย ย ย ย ย ย ย ย ย ย ย ย let answers = [];

ย ย ย ย ย ย ย ย ย ย ย ย if(['A','B','C','D'].includes(rawAns) && rawAns.length === 1) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย type = 'mcq';
ย ย ย ย ย ย ย ย ย ย ย ย } else if (rawAns.length === 4 && /^[ฤS]+$/.test(rawAns)) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย type = 'true_false';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย answers = rawAns.split(''); // ['ฤ','S','ฤ','S']
ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย // Get Images (async base64 conversion)
ย ย ย ย ย ย ย ย ย ย ย ย const qFile = qImgMap[stt];
ย ย ย ย ย ย ย ย ย ย ย ย const sFile = sImgMap[stt];
ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย let qBase64 = null;
ย ย ย ย ย ย ย ย ย ย ย ย let sBase64 = null;

ย ย ย ย ย ย ย ย ย ย ย ย if(qFile) qBase64 = await fileToBase64(qFile);
ย ย ย ย ย ย ย ย ย ย ย ย if(sFile) sBase64 = await fileToBase64(sFile);

ย ย ย ย ย ย ย ย ย ย ย ย // Create DOM Element
ย ย ย ย ย ย ย ย ย ย ย ย const div = document.createElement('div');
ย ย ย ย ย ย ย ย ย ย ย ย const idx = container.children.length; // Use current length for ID uniqueness
ย ย ย ย ย ย ย ย ย ย ย ย div.className = "card border border-gray-200 shadow-sm relative";
ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย // Pre-fill HTML based on Type
ย ย ย ย ย ย ย ย ย ย ย ย let ansHtml = '';
ย ย ย ย ย ย ย ย ย ย ย ย if(type === 'mcq') {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ansHtml = `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-bold">ฤรกp รกn ฤรบng:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select class="input-field mt-1 q-ans-mcq">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="A" ${ans==='A'?'selected':''}>A</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="B" ${ans==='B'?'selected':''}>B</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="C" ${ans==='C'?'selected':''}>C</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="D" ${ans==='D'?'selected':''}>D</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย ย ย ย ย } else if(type === 'short_answer') {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ansHtml = `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-bold">Nhแบญp ฤรกp รกn ฤรบng (Text):</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" class="input-field mt-1 q-ans-sa" value="${ans}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย ย ย ย ย } else if (type === 'true_false') {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ansHtml = `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-bold mb-2 block">Cแบฅu hรฌnh ฤรบng/Sai:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-4 gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${['a','b','c','d'].map((label, k) => `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="block text-xs font-bold uppercase">ร ${label}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select class="input-field mt-1 text-sm q-ans-tf">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="S" ${answers[k]==='S'?'selected':''}>Sai</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="ฤ" ${answers[k]==='ฤ'?'selected':''}>ฤรบng</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย ย ย div.innerHTML = `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="absolute top-4 right-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="this.closest('.card').remove()" class="text-red-500 hover:text-red-700 font-bold">โ Xรณa</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h4 class="font-bold text-gray-700 mb-2">Cรขu hแปi ${idx + 1} (Import tแปซ Excel: STT ${stt})</h4>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-semibold">Loแบกi cรขu hแปi:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select class="input-field mt-1 q-type" onchange="changeQType(this, ${idx})">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="mcq" ${type==='mcq'?'selected':''}>Trแบฏc nghiแปm (A/B/C/D)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="true_false" ${type==='true_false'?'selected':''}>ฤรบng/Sai (4 รฝ)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="short_answer" ${type==='short_answer'?'selected':''}>Trแบฃ lแปi ngแบฏn</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-semibold block mb-1">แบขnh ฤแป bรi:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" accept="image/*" class="text-sm q-img-file" onchange="previewImage(this, 'preview-q-${idx}')">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="hidden" class="q-img-base64-hidden" value="${qBase64 || ''}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <img id="preview-q-${idx}" class="mt-2 h-32 object-contain ${qBase64 ? '' : 'hidden'} border rounded" src="${qBase64 ? 'data:image/png;base64,'+qBase64 : ''}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${!qBase64 ? '<p class="text-xs text-red-500 mt-1">โ๏ธ Khรดng tรฌm thแบฅy แบฃnh Cรขu hแปi (VD: Cau_'+stt+'.jpg)</p>' : ''}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-semibold block mb-1">แบขnh Lแปi giแบฃi (Tรนy chแปn):</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" accept="image/*" class="text-sm q-sol-file" onchange="previewImage(this, 'preview-s-${idx}')">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="hidden" class="q-sol-base64-hidden" value="${sBase64 || ''}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <img id="preview-s-${idx}" class="mt-2 h-32 object-contain ${sBase64 ? '' : 'hidden'} border rounded" src="${sBase64 ? 'data:image/png;base64,'+sBase64 : ''}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${!sBase64 ? '<p class="text-xs text-gray-500 mt-1 italic">Khรดng tรฌm thแบฅy แบฃnh Lแปi giแบฃi (VD: Da_'+stt+'.jpg)</p>' : ''}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-3 rounded border" id="ans-container-${idx}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${ansHtml}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย ย ย ย ย container.appendChild(div);
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย customAlert(`ฤรฃ xแปญ lรฝ xong! Tรฌm thแบฅy ${validRows.length-1} dรฒng dแปฏ liแปu.`); // -1 for header estimate
ย ย ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย ย ย btn.innerText = "โก Tแบกo cรขu hแปi";

ย ย ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย ย ย console.error(err);
ย ย ย ย ย ย ย ย ย ย customAlert("Lแปi xแปญ lรฝ file: " + err.message);
ย ย ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย ย ย btn.innerText = "โก Tแบกo cรขu hแปi";
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย };
ย ย ย ย ย ย reader.readAsArrayBuffer(excelInput.files[0]);
ย ย ย ย }


ย ย ย ย window.addQuestion = () => {
ย ย ย ย ย ย const container = document.getElementById('questions-list');
ย ย ย ย ย ย const idx = container.children.length;
ย ย ย ย ย ย const div = document.createElement('div');
ย ย ย ย ย ย div.className = "card border border-gray-200 shadow-sm relative";
ย ย ย ย ย ย div.innerHTML = `
ย ย ย ย ย ย ย ย <div class="absolute top-4 right-4">
ย ย ย ย ย ย ย ย ย ย <button onclick="this.closest('.card').remove()" class="text-red-500 hover:text-red-700 font-bold">โ Xรณa</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <h4 class="font-bold text-gray-700 mb-2">Cรขu hแปi ${idx + 1}</h4>
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย <div class="mb-4">
ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-semibold">Loแบกi cรขu hแปi:</label>
ย ย ย ย ย ย ย ย ย ย <select class="input-field mt-1 q-type" onchange="changeQType(this, ${idx})">
ย ย ย ย ย ย ย ย ย ย ย ย <option value="mcq">Trแบฏc nghiแปm (A/B/C/D)</option>
ย ย ย ย ย ย ย ย ย ย ย ย <option value="true_false">ฤรบng/Sai (4 รฝ)</option>
ย ย ย ย ย ย ย ย ย ย ย ย <option value="short_answer">Trแบฃ lแปi ngแบฏn</option>
ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-semibold block mb-1">แบขnh ฤแป bรi:</label>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" accept="image/*" class="text-sm q-img-file" onchange="previewImage(this, 'preview-q-${idx}')">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="hidden" class="q-img-base64-hidden" value="">
ย ย ย ย ย ย ย ย ย ย ย ย <img id="preview-q-${idx}" class="mt-2 h-32 object-contain hidden border rounded">
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-semibold block mb-1">แบขnh Lแปi giแบฃi (Tรนy chแปn):</label>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" accept="image/*" class="text-sm q-sol-file" onchange="previewImage(this, 'preview-s-${idx}')">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="hidden" class="q-sol-base64-hidden" value="">
ย ย ย ย ย ย ย ย ย ย ย ย <img id="preview-s-${idx}" class="mt-2 h-32 object-contain hidden border rounded">
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-3 rounded border" id="ans-container-${idx}">
ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-bold">ฤรกp รกn ฤรบng:</label>
ย ย ย ย ย ย ย ย ย ย <select class="input-field mt-1 q-ans-mcq">
ย ย ย ย ย ย ย ย ย ย ย ย <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย `;
ย ย ย ย ย ย container.appendChild(div);
ย ย ย ย ย ย return div;ย
ย ย ย ย }

ย ย ย ย window.changeQType = (select, idx) => {
ย ย ย ย ย ย const container = document.getElementById(`ans-container-${idx}`);
ย ย ย ย ย ย const type = select.value;
ย ย ย ย ย ย if (type === 'mcq') {
ย ย ย ย ย ย ย ย container.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-bold">ฤรกp รกn ฤรบng:</label>
ย ย ย ย ย ย ย ย ย ย <select class="input-field mt-1 q-ans-mcq">
ย ย ย ย ย ย ย ย ย ย ย ย <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย } else if (type === 'short_answer') {
ย ย ย ย ย ย ย ย container.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-bold">Nhแบญp ฤรกp รกn ฤรบng (Text):</label>
ย ย ย ย ย ย ย ย ย ย <input type="text" class="input-field mt-1 q-ans-sa" placeholder="VD: 42 hoแบทc Paris">
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย } else if (type === 'true_false') {
ย ย ย ย ย ย ย ย container.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <label class="text-sm font-bold mb-2 block">Cแบฅu hรฌnh ฤรบng/Sai:</label>
ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-4 gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ${['a','b','c','d'].map((label, k) => `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="block text-xs font-bold uppercase">ร ${label}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select class="input-field mt-1 text-sm q-ans-tf">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="S">Sai</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="ฤ">ฤรบng</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย window.saveExam = async (btnElement) => {
ย ย ย ย ย ย const btn = btnElement || event.target;
ย ย ย ย ย ย btn.disabled = true;
ย ย ย ย ย ย btn.innerText = "ฤang xแปญ lรฝ...";

ย ย ย ย ย ย // Check if Firebase is configured properly
ย ย ย ย ย ย if (!isFirebaseConfigured()) {
ย ย ย ย ย ย ย ย customAlert("Lแปi: Firebase chฦฐa ฤฦฐแปฃc cแบฅu hรฌnh. Vui lรฒng ฤiแปn cแบฅu hรฌnh Firebase cแปงa bแบกn ฤแป sแปญ dแปฅng tรญnh nฤng Lฦฐu/Tแบฃi.", "LแปI CแบคU HรNH");
ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย btn.innerText = "๐พ Tแบกo ฤแป";
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const tNameInput = document.getElementById('t-name');
ย ย ย ย ย ย ย ย const tName = tNameInput.value.trim();
ย ย ย ย ย ย ย ย const tTime = document.getElementById('t-time').value;
ย ย ย ย ย ย ย ย const tReview = document.getElementById('t-review').checked;
ย ย ย ย ย ย ย ย const questionsDivs = document.getElementById('questions-list').children;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // --- VALIDATION WITH UI FEEDBACK ---
ย ย ย ย ย ย ย ย if (!tName) {
ย ย ย ย ย ย ย ย ย ย tNameInput.focus();
ย ย ย ย ย ย ย ย ย ย tNameInput.classList.add('input-error');
ย ย ย ย ย ย ย ย ย ย tNameInput.addEventListener('input', () => tNameInput.classList.remove('input-error'), {once: true});
ย ย ย ย ย ย ย ย ย ย throw new Error("Vui lรฒng nhแบญp tรชn giรกo viรชn vรo รด phรญa trรชn.");
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย if (questionsDivs.length === 0) throw new Error("ฤแป thi phแบฃi cรณ รญt nhแบฅt 1 cรขu hแปi");

ย ย ย ย ย ย ย ย const questions = [];
ย ย ย ย ย ย ย ย for (let i = 0; i < questionsDivs.length; i++) {
ย ย ย ย ย ย ย ย ย ย const div = questionsDivs[i];
ย ย ย ย ย ย ย ย ย ย const type = div.querySelector('.q-type').value;
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย const hiddenQ = div.querySelector('.q-img-base64-hidden').value;
ย ย ย ย ย ย ย ย ย ย const hiddenS = div.querySelector('.q-sol-base64-hidden').value;

ย ย ย ย ย ย ย ย ย ย let imgBase64 = hiddenQ;
ย ย ย ย ย ย ย ย ย ย if(!imgBase64) {
ย ย ย ย ย ย ย ย ย ย ย ย imgBase64 = await fileToBase64(div.querySelector('.q-img-file'));
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย ย ย let solBase64 = hiddenS;
ย ย ย ย ย ย ย ย ย ย if(!solBase64) {
ย ย ย ย ย ย ย ย ย ย ย ย solBase64 = await fileToBase64(div.querySelector('.q-sol-file'));
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย if (!imgBase64) {
ย ย ย ย ย ย ย ย ย ย ย ย ยthrow new Error(`Cรขu ${i+1} chฦฐa chแปn แบฃnh ฤแป bรi!`);
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย // --- NEW SIZE CHECK (Prevent 1MB limit error) ---
ย ย ย ย ย ย ย ย ย ย if (imgBase64.length > MAX_BASE64_SIZE) {
ย ย ย ย ย ย ย ย ย ย ย ย throw new Error(`Kรญch thฦฐแปc แบฃnh cรขu hแปi ${i + 1} quรก lแปn (${(imgBase64.length/1024/1024).toFixed(2)}MB Base64). Vui lรฒng sแปญ dแปฅng แบฃnh cรณ kรญch thฦฐแปc gแปc **dฦฐแปi 1MB**.`);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย if (solBase64 && solBase64.length > MAX_BASE64_SIZE) {
ย ย ย ย ย ย ย ย ย ย ย ย throw new Error(`Kรญch thฦฐแปc แบฃnh lแปi giแบฃi cรขu hแปi ${i + 1} quรก lแปn (${(solBase64.length/1024/1024).toFixed(2)}MB Base64). Vui lรฒng sแปญ dแปฅng แบฃnh cรณ kรญch thฦฐแปc gแปc **dฦฐแปi 1MB**.`);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย // --- END NEW SIZE CHECK ---


ย ย ย ย ย ย ย ย ย ย let answerData = {};
ย ย ย ย ย ย ย ย ย ย if (type === 'mcq') {
ย ย ย ย ย ย ย ย ย ย ย ย answerData = { answer: div.querySelector('.q-ans-mcq').value };
ย ย ย ย ย ย ย ย ย ย } else if (type === 'short_answer') {
ย ย ย ย ย ย ย ย ย ย ย ย answerData = { answer: div.querySelector('.q-ans-sa').value.trim() };
ย ย ย ย ย ย ย ย ย ย } else if (type === 'true_false') {
ย ย ย ย ย ย ย ย ย ย ย ย const selects = div.querySelectorAll('.q-ans-tf');
ย ย ย ย ย ย ย ย ย ย ย ย answerData = { answers: Array.from(selects).map(s => s.value) };
ย ย ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย ย ย questions.push({
ย ย ย ย ย ย ย ย ย ย ย ย type,
ย ย ย ย ย ย ย ย ย ย ย ย img_data: imgBase64,
ย ย ย ย ย ย ย ย ย ย ย ย da_img_data: solBase64,
ย ย ย ย ย ย ย ย ย ย ย ย ...answerData
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย const scoring = {
ย ย ย ย ย ย ย ย ย ย mcq: parseFloat(document.getElementById('score-mcq').value),
ย ย ย ย ย ย ย ย ย ย sa: parseFloat(document.getElementById('score-sa').value),
ย ย ย ย ย ย ย ย ย ย tf_1: parseFloat(document.getElementById('score-tf1').value),
ย ย ย ย ย ย ย ย ย ย tf_2: parseFloat(document.getElementById('score-tf2').value),
ย ย ย ย ย ย ย ย ย ย tf_3: parseFloat(document.getElementById('score-tf3').value),
ย ย ย ย ย ย ย ย ย ย tf_4: parseFloat(document.getElementById('score-tf4').value),
ย ย ย ย ย ย ย ย };

ย ย ย ย ย ย ย ย const examId = Math.random().toString(36).substring(2, 8).toUpperCase();
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // --- 1. Save Main Doc (Metadata ONLY) ---
ย ย ย ย ย ย ย ย const examMetadata = {
ย ย ย ย ย ย ย ย ย ย teacher: tName,
ย ย ย ย ย ย ย ย ย ย time: parseInt(tTime),
ย ย ย ย ย ย ย ย ย ย allow_review: tReview,
ย ย ย ย ย ย ย ย ย ย scoring,
ย ย ย ย ย ย ย ย ย ย question_count: questions.length, // Store count
ย ย ย ย ย ย ย ย ย ย created_at: new Date().toISOString()
ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itex_exams', examId), examMetadata);

ย ย ย ย ย ย ย ย // --- 2. Save Questions Individually (Split) ---
ย ย ย ย ย ย ย ย const writePromises = questions.map((q, index) => {
ย ย ย ย ย ย ย ย ย ย // Save question data. No need to store examId within the question doc itself,ย
ย ย ย ย ย ย ย ย ย ย // as the document ID already links it: {examId}_{index}
ย ย ย ย ย ย ย ย ย ย return setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itex_questions', `${examId}_${index}`), q);
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย await Promise.all(writePromises);

ย ย ย ย ย ย ย ย // --- 3. Create Results Doc ---
ย ย ย ย ย ย ย ย await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itex_results', examId), {
ย ย ย ย ย ย ย ย ย ย results: []
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย // CแบฌP NHแบฌT: Hiแปn thแป mรฃ ฤแป vร chแป tแบฃi lแบกi trang khi ngฦฐแปi dรนng ฤรณng alert
ย ย ย ย ย ย ย ย const alertMessage = `
ย ย ย ย ย ย ย ย ย ย <p class="mb-3">โ Tแบกo ฤแป thรnh cรดng!</p>
ย ย ย ย ย ย ย ย ย ย <p class="text-xl font-extrabold text-primary p-3 bg-gray-100 rounded-lg border border-primary">
ย ย ย ย ย ย ย ย ย ย ย ย Mร ฤแป THI: ${examId}
ย ย ย ย ย ย ย ย ย ย </p>
ย ย ย ย ย ย ย ย ย ย <p class="mt-3 text-sm text-gray-500">Vui lรฒng ghi lแบกi mรฃ ฤแป nรy.</p>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย customAlert(alertMessage, "THรNG BรO QUAN TRแปNG", () => {
ย ย ย ย ย ย ย ย ย ย // Hรnh ฤแปng sau khi ngฦฐแปi dรนng ฤรณng alert
ย ย ย ย ย ย ย ย ย ย location.reload();ย
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย customAlert(e.message, "Lแปi Lฦฐu ฤแป Thi");
ย ย ย ย ย ย ย ย if (!e.message.startsWith("Vui lรฒng") && !e.message.startsWith("ฤแป thi") && !e.message.startsWith("Cรขu") && !e.message.startsWith("Kรญch thฦฐแปc")) {
ย ย ย ย ย ย ย ย ย ย ยconsole.error(e);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย btn.innerText = "๐พ Tแบกo ฤแป";
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // Hรm render biแปu ฤแป cแปt
ย ย ย ย const renderScoreChart = (results, examId) => {
ย ย ย ย ย ย const chartContainer = document.getElementById('results-chart-container');
ย ย ย ย ย ย const chartCanvas = document.getElementById('scoreChart');

ย ย ย ย ย ย if (results.length === 0) {
ย ย ย ย ย ย ย ย chartContainer.classList.add('hidden');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย // Show chart container
ย ย ย ย ย ย chartContainer.classList.remove('hidden');

ย ย ย ย ย ย // Destroy existing chart instance if it exists
ย ย ย ย ย ย if (scoreChartInstance) {
ย ย ย ย ย ย ย ย scoreChartInstance.destroy();
ย ย ย ย ย ย }

ย ย ย ย ย ย const labels = results.map(r => r.name);
ย ย ย ย ย ย const data = results.map(r => r.score);
ย ย ย ย ย ย const maxScore = results.length > 0 ? Math.ceil(Math.max(...data)) : 0;
ย ย ย ย ย ย const maxPossibleScore = 10; // Giแบฃ ฤแปnh thang ฤiแปm tแปi ฤa lร 10

ย ย ย ย ย ย // Thay ฤแปi mรu cแปt thรnh #04CCCC
ย ย ย ย ย ย const backgroundColor = '#04CCCC';ย


ย ย ย ย ย ย const chartData = {
ย ย ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย ย ย label: 'Tแปng ฤiแปm',
ย ย ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย ย ย backgroundColor: backgroundColor,
ย ย ย ย ย ย ย ย ย ย borderColor: backgroundColor,
ย ย ย ย ย ย ย ย ย ย borderWidth: 1,
ย ย ย ย ย ย ย ย ย ย borderRadius: 5,
ย ย ย ย ย ย ย ย }]
ย ย ย ย ย ย };

ย ย ย ย ย ย const config = {
ย ย ย ย ย ย ย ย type: 'bar',
ย ย ย ย ย ย ย ย data: chartData,
ย ย ย ย ย ย ย ย options: {
ย ย ย ย ย ย ย ย ย ย responsive: true,
ย ย ย ย ย ย ย ย ย ย maintainAspectRatio: false, // Cho phรฉp tรนy chแปnh kรญch thฦฐแปc
ย ย ย ย ย ย ย ย ย ย scales: {
ย ย ย ย ย ย ย ย ย ย ย ย y: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย beginAtZero: true,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย max: Math.min(10, Math.max(maxScore + 1, maxPossibleScore)), // Max Y-axis lร max(score) + 1, nhฦฐng khรดng quรก 10
ย ย ย ย ย ย ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย text: 'ฤiแปm sแป'
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย ย ย x: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย text: 'Hแปc sinh'
ย ย ย ย ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ticks: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Xoay nhรฃn trแปฅc X 90 ฤแป
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย maxRotation: 90,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย minRotation: 90,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Thรชm tuแปณ chแปn cho nhรฃn dรi
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย autoSkipPadding: 10
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย ย ย ย ย legend: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย display: false
ย ย ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย ย ย title: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย display: true,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย text: `Phรขn phแปi ฤiแปm thi - Mรฃ ฤแป ${examId}`
ย ย ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย ย ย tooltip: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย callbacks: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย label: function(context) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย let label = context.dataset.label || '';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (label) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย label += ': ';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย if (context.parsed.y !== null) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย label += new Intl.NumberFormat('vi-VN', { minimumFractionDigits: 2 }).format(context.parsed.y) + ' ฤiแปm';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย return label;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย };
ย ย ย ย ย ย 
ย ย ย ย ย ย scoreChartInstance = new Chart(chartCanvas, config);
ย ย ย ย }

ย ย ย ย window.loadResults = async () => {
ย ย ย ย ย ย ย// Check if Firebase is configured properly
ย ย ย ย ย ย if (!isFirebaseConfigured()) {
ย ย ย ย ย ย ย ย customAlert("Lแปi: Firebase chฦฐa ฤฦฐแปฃc cแบฅu hรฌnh. Vui lรฒng ฤiแปn cแบฅu hรฌnh Firebase cแปงa bแบกn ฤแป sแปญ dแปฅng tรญnh nฤng Lฦฐu/Tแบฃi.", "LแปI CแบคU HรNH");
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย const examId = document.getElementById('result-exam-id').value.trim().toUpperCase();
ย ย ย ย ย ย if (!examId) return customAlert("Vui lรฒng nhแบญp mรฃ ฤแป");

ย ย ย ย ย ย const container = document.getElementById('results-table-container');
ย ย ย ย ย ย // Xรณa nแปi dung cลฉ (bแบฃng vร chart container)
ย ย ย ย ย ย container.innerHTML = `
ย ย ย ย ย ย ย ย <div class="card p-6 mb-6 hidden" id="results-chart-container">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 mb-4">Phรขn tรญch Tแปng ฤiแปm</h3>
ย ย ย ย ย ย ย ย ย ย <div style="height: 400px;"><canvas id="scoreChart"></canvas></div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <p class="text-center">ฤang tแบฃi...</p>
ย ย ย ย ย ย `;

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // Fix Path: itex_results/{examId}
ย ย ย ย ย ย ย ย const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itex_results', examId));
ย ย ย ย ย ย ย ย if (!docSnap.exists()) throw new Error("Khรดng tรฌm thแบฅy dแปฏ liแปu kแบฟt quแบฃ cho mรฃ ฤแป nรy");

ย ย ย ย ย ย ย ย const data = docSnap.data();
ย ย ย ย ย ย ย ย const results = data.results || [];

ย ย ย ย ย ย ย ย // Xรณa message "ฤang tแบฃi"
ย ย ย ย ย ย ย ย container.querySelector('p').remove();ย

ย ย ย ย ย ย ย ย if (results.length === 0) {
ย ย ย ย ย ย ย ย ย ย container.innerHTML = `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="card p-6 mb-6 hidden" id="results-chart-container">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 mb-4">Phรขn tรญch Tแปng ฤiแปm</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div style="height: 400px;"><canvas id="scoreChart"></canvas></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-center italic">Chฦฐa cรณ bรi nแปp nรo.</p>
ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // Sแบฏp xแบฟp theo ฤiแปm giแบฃm dแบงn
ย ย ย ย ย ย ย ย results.sort((a, b) => b.score - a.score);
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // --- RENDER CHART ---
ย ย ย ย ย ย ย ย renderScoreChart(results, examId);ย
ย ย ย ย ย ย ย ย // --- END CHART ---

ย ย ย ย ย ย ย ย let htmlTable = `
ย ย ย ย ย ย ย ย ย ย <div class="mb-4 flex justify-between items-center mt-6">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="font-bold text-gray-700">Tแปng: ${results.length} bรi nแปp</span>
ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="exportExcel('${examId}')" class="btn bg-green-600 text-sm">๐ค Xuแบฅt Excel</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <table class="min-w-full bg-white border border-gray-200">
ย ย ย ย ย ย ย ย ย ย ย ย <thead class="bg-gray-100">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="py-2 px-4 border-b text-left">Hแปc sinh</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="py-2 px-4 border-b text-left">Lแปp</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="py-2 px-4 border-b text-left">Trฦฐแปng</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="py-2 px-4 border-b text-center font-bold text-primary">ฤiแปm</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="py-2 px-4 border-b text-right">Thแปi gian nแปp</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย results.forEach(r => {
ย ย ย ย ย ย ย ย ย ย htmlTable += `
ย ย ย ย ย ย ย ย ย ย ย ย <tr class="hover:bg-gray-50">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="py-2 px-4 border-b font-medium">${r.name}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="py-2 px-4 border-b">${r.class_}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="py-2 px-4 border-b">${r.school}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="py-2 px-4 border-b text-center font-bold text-lg">${r.score.toFixed(2)}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="py-2 px-4 border-b text-right text-sm text-gray-500">${new Date(r.submittedAt).toLocaleString()}</td>
ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย htmlTable += '</tbody></table>';
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Thรชm bแบฃng vรo container sau biแปu ฤแป
ย ย ย ย ย ย ย ย container.insertAdjacentHTML('beforeend', htmlTable);

ย ย ย ย ย ย ย ย // Lฦฐu global ฤแป export
ย ย ย ย ย ย ย ย window.currentResults = results;

ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย container.innerHTML = `<p class="text-red-500 text-center">Lแปi: ${e.message}</p>`;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย window.exportExcel = (examId) => {
ย ย ย ย ย ย if (!window.currentResults) return;
ย ย ย ย ย ย const ws = XLSX.utils.json_to_sheet(window.currentResults.map(r => ({
ย ย ย ย ย ย ย ย "Hแป Tรชn": r.name,
ย ย ย ย ย ย ย ย "Trฦฐแปng": r.school,
ย ย ย ย ย ย ย ย "Lแปp": r.class_,
ย ย ย ย ย ย ย ย "ฤiแปm": r.score,
ย ย ย ย ย ย ย ย "Thแปi gian nแปp": new Date(r.submittedAt).toLocaleString()
ย ย ย ย ย ย })));
ย ย ย ย ย ย const wb = XLSX.utils.book_new();
ย ย ย ย ย ย XLSX.utils.book_append_sheet(wb, ws, "KetQua");
ย ย ย ย ย ย XLSX.writeFile(wb, `KetQua_${examId}.xlsx`);
ย ย ย ย }

ย ย ย ย // --- STUDENT LOGIC ---

ย ย ย ย window.checkExam = async () => {
ย ย ย ย ย ย // Check if Firebase is configured properly
ย ย ย ย ย ย if (!isFirebaseConfigured()) {
ย ย ย ย ย ย ย ย customAlert("Lแปi: Firebase chฦฐa ฤฦฐแปฃc cแบฅu hรฌnh. Vui lรฒng ฤiแปn cแบฅu hรฌnh Firebase cแปงa bแบกn ฤแป sแปญ dแปฅng tรญnh nฤng Lฦฐu/Tแบฃi.", "LแปI CแบคU HรNH");
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย const examId = document.getElementById('s-exam-id').value.trim().toUpperCase();
ย ย ย ย ย ย if (!examId) return customAlert("Vui lรฒng nhแบญp mรฃ ฤแป");

ย ย ย ย ย ย const btn = event.target;
ย ย ย ย ย ย btn.innerText = "ฤang kiแปm tra...";
ย ย ย ย ย ย btn.disabled = true;

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // Fix Path: itex_exams/{examId} (metadata)
ย ย ย ย ย ย ย ย const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itex_exams', examId));
ย ย ย ย ย ย ย ย if (!docSnap.exists()) throw new Error("Mรฃ ฤแป khรดng tแปn tแบกi");

ย ย ย ย ย ย ย ย currentExamData = docSnap.data();
ย ย ย ย ย ย ย ย currentExamData.id = examId; // Lฦฐu ID lแบกi
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย document.getElementById('student-entry').classList.add('hidden');
ย ย ย ย ย ย ย ย document.getElementById('student-info-form').classList.remove('hidden');
ย ย ย ย ย ย ย ย document.getElementById('exam-info-display').innerText = `ฤแป cแปงa GV: ${currentExamData.teacher} - Thแปi gian: ${currentExamData.time} phรบt`;

ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย customAlert(e.message);
ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย btn.innerText = "Kiแปm Tra Mรฃ ฤแป";
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // ฤรฃ sแปญa: Thรชm tham sแป event vรo ฤแปnh nghฤฉa hรm
ย ย ย ย window.startExam = async (event) => {
ย ย ย ย ย ย const name = document.getElementById('s-name').value.trim();
ย ย ย ย ย ย const school = document.getElementById('s-school').value.trim();
ย ย ย ย ย ย const sClass = document.getElementById('s-class').value.trim();

ย ย ย ย ย ย if (!name || !school || !sClass) return customAlert("Vui lรฒng ฤiแปn ฤแบงy ฤแปง thรดng tin");

ย ย ย ย ย ย // Fix Path: itex_results/{examId}
ย ย ย ย ย ย const resSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itex_results', currentExamData.id));
ย ย ย ย ย ย if (resSnap.exists()) {
ย ย ย ย ย ย ย ย const existing = resSnap.data().results.find(r =>ย
ย ย ย ย ย ย ย ย ย ย r.name.toLowerCase() === name.toLowerCase() &&ย
ย ย ย ย ย ย ย ย ย ย r.class_.toLowerCase() === sClass.toLowerCase()
ย ย ย ย ย ย ย ย );
ย ย ย ย ย ย ย ย if (existing) return customAlert("Bแบกn ฤรฃ nแปp bรi thi nรy rแปi! Khรดng thแป thi lแบกi.");
ย ย ย ย ย ย }

ย ย ย ย ย ย // Dรฒng nรy giแป hoแบกt ฤแปng vรฌ event ฤรฃ ฤฦฐแปฃc truyแปn vรo
ย ย ย ย ย ย const btn = event.target;ย
ย ย ย ย ย ย btn.innerText = "ฤang tแบฃi ฤแป...";
ย ย ย ย ย ย btn.disabled = true;

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // --- FETCH QUESTIONS (Split Logic) ---
ย ย ย ย ย ย ย ย // We know 'question_count' from metadata. fetch id_0, id_1, ...
ย ย ย ย ย ย ย ย const qPromises = [];
ย ย ย ย ย ย ย ย for(let i=0; i<currentExamData.question_count; i++) {
ย ย ย ย ย ย ย ย ย ย qPromises.push(getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itex_questions', `${currentExamData.id}_${i}`)));
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย const qSnaps = await Promise.all(qPromises);
ย ย ย ย ย ย ย ย const fetchedQuestions = qSnaps.map(s => {
ย ย ย ย ย ย ย ย ย ย if(!s.exists()) throw new Error("Lแปi tแบฃi cรขu hแปi. Dแปฏ liแปu khรดng ฤแบงy ฤแปง.");
ย ย ย ย ย ย ย ย ย ย return s.data();
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย currentExamData.questions = fetchedQuestions;

ย ย ย ย ย ย ย ย // Randomize Questions (Group Shuffle Logic like Streamlit)
ย ย ย ย ย ย ย ย const groups = { mcq: [], true_false: [], short_answer: [] };
ย ย ย ย ย ย ย ย currentExamData.questions.forEach((q, idx) => {
ย ย ย ย ย ย ย ย ย ย groups[q.type].push({ ...q, originalIdx: idx });
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Shuffle each group
ย ย ย ย ย ย ย ย const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
ย ย ย ย ย ย ย ย const shuffledQ = [...shuffle(groups.mcq), ...shuffle(groups.true_false), ...shuffle(groups.short_answer)];
ย ย ย ย ย ย ย ย currentExamData.shuffledQuestions = shuffledQ;

ย ย ย ย ย ย ย ย // UI Setup
ย ย ย ย ย ย ย ย document.getElementById('student-info-form').classList.add('hidden');
ย ย ย ย ย ย ย ย document.getElementById('taking-exam').classList.remove('hidden');
ย ย ย ย ย ย ย ย document.getElementById('display-s-name').innerText = name;

ย ย ย ย ย ย ย ย renderStudentQuestions();
ย ย ย ย ย ย ย ย startTimer(currentExamData.time);

ย ย ย ย ย ย } catch(e) {
ย ย ย ย ย ย ย ย customAlert("Lแปi khi tแบฃi ฤแป thi: " + e.message);
ย ย ย ย ย ย ย ย btn.innerText = "๐ BแบฎT ฤแบฆU LรM BรI";
ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย const renderStudentQuestions = () => {
ย ย ย ย ย ย const container = document.getElementById('exam-questions-render');
ย ย ย ย ย ย container.innerHTML = '';
ย ย ย ย ย ย 
ย ย ย ย ย ย currentExamData.shuffledQuestions.forEach((q, i) => {
ย ย ย ย ย ย ย ย let inputHtml = '';
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย if (q.type === 'mcq') {
ย ย ย ย ย ย ย ย ย ย inputHtml = `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${['A','B','C','D'].map(opt => `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button onclick="selectMCQ(${i}, '${opt}')" id="btn-mcq-${i}-${opt}" class="option-btn text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${opt}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <input type="hidden" id="ans-${i}">
ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย } else if (q.type === 'short_answer') {
ย ย ย ย ย ย ย ย ย ย inputHtml = `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="mt-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="ans-${i}" class="input-field" placeholder="Nhแบญp cรขu trแบฃ lแปi cแปงa bแบกn...">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย } else if (q.type === 'true_false') {
ย ย ย ย ย ย ย ย ย ย // Render 4 cแบทp radio button ฤรบng/Sai
ย ย ย ย ย ย ย ย ย ย inputHtml = `
ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${['a', 'b', 'c', 'd'].map((label, j) => `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="p-3 border rounded-lg bg-white shadow-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="block text-sm font-bold text-gray-700 mb-2">ร ${label.toUpperCase()}</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-around space-x-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="flex items-center space-x-1 cursor-pointer">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="radio" name="tf-${i}-${j}" value="ฤ" class="text-primary focus:ring-primary">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-sm font-medium text-green-600">ฤรบng</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label class="flex items-center space-x-1 cursor-pointer">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="radio" name="tf-${i}-${j}" value="S" class="text-primary focus:ring-primary">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="text-sm font-medium text-red-600">Sai</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย `).join('')}
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย const div = document.createElement('div');
ย ย ย ย ย ย ย ย div.className = "card";
ย ย ย ย ย ย ย ย div.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <div class="mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs font-bold uppercase mb-2 inline-block">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ${q.type === 'mcq' ? 'Trแบฏc nghiแปm' : q.type === 'true_false' ? 'ฤรบng/Sai' : 'Tแปฑ luแบญn'}
ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย <h4 class="font-bold text-gray-800 text-lg">Cรขu ${i + 1}</h4>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <img src="data:image/png;base64,${q.img_data}" class="max-h-64 object-contain rounded border mb-4 w-full">
ย ย ย ย ย ย ย ย ย ย ${inputHtml}
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย container.appendChild(div);
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย window.selectMCQ = (qIdx, opt) => {
ย ย ย ย ย ย // Reset visual
ย ย ย ย ย ย ['A','B','C','D'].forEach(o => {
ย ย ย ย ย ย ย ย document.getElementById(`btn-mcq-${qIdx}-${o}`).classList.remove('selected');
ย ย ย ย ย ย });
ย ย ย ย ย ย // Select
ย ย ย ย ย ย document.getElementById(`btn-mcq-${qIdx}-${opt}`).classList.add('selected');
ย ย ย ย ย ย document.getElementById(`ans-${qIdx}`).value = opt;
ย ย ย ย }

ย ย ย ย const startTimer = (minutes) => {
ย ย ย ย ย ย let time = minutes * 60;
ย ย ย ย ย ย const display = document.getElementById('timer');
ย ย ย ย ย ย examTimer = setInterval(() => {
ย ย ย ย ย ย ย ย const m = Math.floor(time / 60);
ย ย ย ย ย ย ย ย const s = time % 60;
ย ย ย ย ย ย ย ย display.innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย if (time <= 0) {
ย ย ย ย ย ย ย ย ย ย clearInterval(examTimer);
ย ย ย ย ย ย ย ย ย ย customAlert("HแบพT GIแป! Hแป thแปng sแบฝ tแปฑ ฤแปng nแปp bรi.");
ย ย ย ย ย ย ย ย ย ย submitExam();
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย time--;
ย ย ย ย ย ย }, 1000);
ย ย ย ย }

ย ย ย ย window.submitExam = async () => {
ย ย ย ย ย ย clearInterval(examTimer);
ย ย ย ย ย ย document.getElementById('btn-submit').disabled = true;
ย ย ย ย ย ย document.getElementById('btn-submit').innerText = "ฤang chแบฅm ฤiแปm...";

ย ย ย ย ย ย const questions = currentExamData.shuffledQuestions;
ย ย ย ย ย ย const scoring = currentExamData.scoring;
ย ย ย ย ย ย let totalScore = 0;
ย ย ย ย ย ย let userAnswers = []; // To save detailed answer for review

ย ย ย ย ย ย questions.forEach((q, i) => {
ย ย ย ย ย ย ย ย let score = 0;
ย ย ย ย ย ย ย ย let uAns = null;
ย ย ย ย ย ย ย ย let isCorrect = false;

ย ย ย ย ย ย ย ย if (q.type === 'mcq') {
ย ย ย ย ย ย ย ย ย ย uAns = document.getElementById(`ans-${i}`).value;
ย ย ย ย ย ย ย ย ย ย if (uAns === q.answer) { score = scoring.mcq; isCorrect = true; }
ย ย ย ย ย ย ย ย }ย
ย ย ย ย ย ย ย ย else if (q.type === 'short_answer') {
ย ย ย ย ย ย ย ย ย ย uAns = document.getElementById(`ans-${i}`).value.trim();
ย ย ย ย ย ย ย ย ย ย // So sรกnh khรดng phรขn biแปt hoa thฦฐแปng, bแป khoแบฃng trแบฏng
ย ย ย ย ย ย ย ย ย ย const normU = uAns.toLowerCase().replace(/\s/g, '');
ย ย ย ย ย ย ย ย ย ย const normA = q.answer.toLowerCase().replace(/\s/g, '');
ย ย ย ย ย ย ย ย ย ย if (normU === normA && normU !== '') { score = scoring.sa; isCorrect = true; }
ย ย ย ย ย ย ย ย }ย
ย ย ย ย ย ย ย ย else if (q.type === 'true_false') {
ย ย ย ย ย ย ย ย ย ย uAns = [];
ย ย ย ย ย ย ย ย ย ย let correctCount = 0;
ย ย ย ย ย ย ย ย ย ย for(let j=0; j<4; j++) {
ย ย ย ย ย ย ย ย ย ย ย ย const radios = document.getElementsByName(`tf-${i}-${j}`);
ย ย ย ย ย ย ย ย ย ย ย ย let val = null;
ย ย ย ย ย ย ย ย ย ย ย ย for(let r of radios) if(r.checked) val = r.value;
ย ย ย ย ย ย ย ย ย ย ย ย uAns.push(val); // 'ฤ', 'S', or null
ย ย ย ย ย ย ย ย ย ย ย ย if (val === q.answers[j]) correctCount++;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย // Logic tรญnh ฤiแปm ฤรบng/Sai theo sแป รฝ ฤรบng
ย ย ย ย ย ย ย ย ย ย if(correctCount === 1) score = scoring.tf_1;
ย ย ย ย ย ย ย ย ย ย if(correctCount === 2) score = scoring.tf_2;
ย ย ย ย ย ย ย ย ย ย if(correctCount === 3) score = scoring.tf_3;
ย ย ย ย ย ย ย ย ย ย if(correctCount === 4) score = scoring.tf_4;
ย ย ย ย ย ย ย ย ย ย if(correctCount === 4) isCorrect = true; // Chแป coi lร ฤรบng hoรn toรn nแบฟu ฤรบng hแบฟt
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย totalScore += score;
ย ย ย ย ย ย ย ย userAnswers.push({ qIdx: i, type: q.type, uAns, score, isCorrect, qData: q });
ย ย ย ย ย ย });

ย ย ย ย ย ย // Save Result
ย ย ย ย ย ย const sName = document.getElementById('s-name').value;
ย ย ย ย ย ย const sSchool = document.getElementById('s-school').value;
ย ย ย ย ย ย const sClass = document.getElementById('s-class').value;

ย ย ย ย ย ย const resultObj = {
ย ย ย ย ย ย ย ย name: sName,
ย ย ย ย ย ย ย ย school: sSchool,
ย ย ย ย ย ย ย ย class_: sClass,
ย ย ย ย ย ย ย ย score: totalScore,
ย ย ย ย ย ย ย ย submittedAt: new Date().toISOString()
ย ย ย ย ย ย };

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // Fix Path: itex_results/{examId}
ย ย ย ย ย ย ย ย await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itex_results', currentExamData.id), {
ย ย ย ย ย ย ย ย ย ย results: arrayUnion(resultObj)
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Show UI
ย ย ย ย ย ย ย ย document.getElementById('taking-exam').classList.add('hidden');
ย ย ย ย ย ย ย ย document.getElementById('student-result').classList.remove('hidden');
ย ย ย ย ย ย ย ย document.getElementById('final-score').innerText = totalScore.toFixed(2);

ย ย ย ย ย ย ย ย if (currentExamData.allow_review) {
ย ย ย ย ย ย ย ย ย ย renderReview(userAnswers);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย customAlert("Lแปi nแปp bรi: " + e.message, "Lแปi Hแป Thแปng");
ย ย ย ย ย ย ย ย console.error(e);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย const renderReview = (userAnswers) => {
ย ย const container = document.getElementById('review-questions');
ย ย const section = document.getElementById('review-section');
ย ย section.classList.remove('hidden');
ย ย container.innerHTML = '';

ย ย userAnswers.forEach((item, i) => {
ย ย ย ย const q = item.qData;ย ย
ย ย ย ย let ansDisplay = '';
ย ย ย ย let correctDisplay = '';

ย ย ย ย if(q.type === 'mcq') {
ย ย ย ย ย ย ansDisplay = `Bแบกn chแปn: <span class="font-bold">${item.uAns || 'Chฦฐa chแปn'}</span>`;
ย ย ย ย ย ย correctDisplay = `ฤรกp รกn: ${q.answer}`;
ย ย ย ย }ย
ย ย ย ย else if(q.type === 'short_answer') {
ย ย ย ย ย ย ansDisplay = `Bแบกn trแบฃ lแปi: <span class="font-bold">${item.uAns || 'Trแปng'}</span>`;
ย ย ย ย ย ย correctDisplay = `ฤรกp รกn: ${q.answer}`;
ย ย ย ย }ย
ย ย ย ย else if(q.type === 'true_false') {
ย ย ย ย ย ย // uAns cรณ thแป lร mแบฃng chแปฉa null/chฦฐa chแปn, cแบงn xแปญ lรฝ
ย ย ย ย ย ย const userAnswerDisplay = item.uAns ? item.uAns.map(x => x || 'X').join(', ') : 'Chฦฐa trแบฃ lแปi';
ย ย ย ย ย ย ansDisplay = `Bแบกn chแปn: ${userAnswerDisplay}`;
ย ย ย ย ย ย correctDisplay = `ฤรกp รกn: ${q.answers.join(', ')}`;
ย ย ย ย }

ย ย ย ย const div = document.createElement('div');
ย ย ย ย div.className = `p-4 rounded border-l-4 mb-4 ${item.score > 0 ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;

ย ย ย ย let solHtml = '';
ย ย ย ย if(q.da_img_data) {
ย ย ย ย ย ย solHtml = `
ย ย ย ย ย ย ย ย <div class="mt-2">
ย ย ย ย ย ย ย ย ย ย <p class="text-xs font-bold text-gray-500">Lแปi giแบฃi:</p>
ย ย ย ย ย ย ย ย ย ย <img src="data:image/png;base64,${q.da_img_data}" class="max-h-40 border rounded mt-1">
ย ย ย ย ย ย ย ย </div>`;
ย ย ย ย }

ย ย ย ย div.innerHTML = `
ย ย ย ย ย ย <div class="flex justify-between">
ย ย ย ย ย ย ย ย <span class="font-bold text-gray-700">Cรขu ${i+1} (${q.type === 'mcq' ? 'Trแบฏc nghiแปm' : q.type === 'true_false' ? 'ฤรบng/Sai' : 'Tแปฑ luแบญn'})</span>
ย ย ย ย ย ย ย ย <span class="font-bold ${item.score > 0 ? 'text-green-600' : 'text-red-600'}">+${item.score.toFixed(2)} ฤ</span>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <img src="data:image/png;base64,${q.img_data}" class="max-h-32 object-contain my-2">
ย ย ย ย ย ย <div class="text-sm">
ย ย ย ย ย ย ย ย <p class="${item.score > 0 ? 'text-green-700' : 'text-red-700'}">${ansDisplay}</p>
ย ย ย ย ย ย ย ย <p class="text-gray-600 font-semibold">${correctDisplay}</p>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย ${solHtml}
ย ย ย ย `;
ย ย ย ย container.appendChild(div);
ย ย });
};

ย ย </script>
</body>
</html>
